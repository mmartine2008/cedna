<script type="text/javascript" src="<?= $this->basePath('/js/operation/permits/forms/jquery.multi-select.js') ?>"></script>
<script>
    var formulario = <?= $formulario ?>;
    var idList = Array();

    function createListFromJSONLista(selector, lista, seleccione) {
        if (seleccione){
            var option = document.createElement("option");
            option.value =  -1;
            option.text = 'Seleccione';
            selector.appendChild(option);
        }
        
        for (var i=0; i < lista.length; i++) {
            var option = document.createElement("option");
            option.value = lista[i];
            option.text = lista[i];
            selector.appendChild(option);
        }
        return selector;
    }

    function obtenerListaOpciones(lista){
        var output = [];
        for (var i=0; i < lista.length; i++) {
            var item = lista[i];
            output.push(item.descripcion);
        }
        return output;
    }

    function createSimpleSelector(id, opciones, divElement) {
        
        var selector = document.createElement("select");
        selector.id = id;
        var opciones = obtenerListaOpciones(opciones);
        var selector = createListFromJSONLista(selector, opciones, true);
        divElement.appendChild(selector);

        idList.push(id);
    }

    function createMultipleSelector(id, name, opciones, divElement, size) {
        var selector = document.createElement("select");
        selector.name = name;
        selector.id = id;
        selector.multiple = true;
        selector.className = "form-control";
        selector.size = size;
        selector.style.marginBottom = "5px";
        var opciones = obtenerListaOpciones(opciones);
        var selector = createListFromJSONLista(selector, opciones, false);
        divElement.appendChild(selector);

        // idList.push(id);
    }

    function createDivClass(info, div) {
        var divClass = document.createElement("Div");
        divClass.className = info;
        div.appendChild(divClass);
        return divClass;
    }

    function createButton(infoType, id, title, divElement, icon, disabled){
        var button = document.createElement("button");
        button.type = infoType;
        button.id = id;
        button.title = title;
        button.className = "btn btn-primary";
        button.textContent = icon;
        button.disabled = disabled;
        button.style.marginTop = "15px";
        // var icono = document.createElement("i");
        // icono.className = "fas fa-angle-left";
        // button.appendChild(icono);
        divElement.appendChild(button);
    }

    function removeAllOptionSelector(origin){
        $('#'+origin).find('option')
            .remove()
            .end();
    }

    function deleteOptions(origin) {
        var select1 = document.getElementById(origin);
        var notSelected = [];
        for (var i = 0; i < select1.length; i++) {
            if (!select1.options[i].selected) notSelected.push(select1.options[i].value);
        }
        removeAllOptionSelector(origin);
        createListFromJSONLista(select1, notSelected, false);
    }

    function manageButtons(){
        if($('#MultiSelectDisp option').length == 0){
            $("#Positive_rightSelected").prop('disabled', true);
            $("#Negative_rightSelected").prop('disabled', true);
        } else {
            $("#Positive_rightSelected").prop('disabled', false);
            $("#Negative_rightSelected").prop('disabled', false);
        }
        if($('#Positive_to option').length == 0){
            $("#Positive_leftSelected").prop('disabled', true);
        } else {
            $("#Positive_leftSelected").prop('disabled', false);
        }
        if($('#Negative_to option').length == 0){
            $("#Negative_leftSelected").prop('disabled', true);
        } else {
            $("#Negative_leftSelected").prop('disabled', false);
        }
    }

    function insertarElementInSelect(origin, destination){
        var select1 = document.getElementById(origin);
        var selected1 = [];
        for (var i = 0; i < select1.length; i++) {
            if (select1.options[i].selected) {
                selected1.push(select1.options[i].value);
            }
        }
        
        var optionOrigin = deleteOptions(origin);
        var selectIn = document.getElementById(destination);
        createListFromJSONLista(selectIn, selected1, false);
        manageButtons();
    }
    
    $(function() {$("#Positive_rightSelected").click(function() {
        insertarElementInSelect("MultiSelectDisp", "Positive_to"); });
        var selectIn = document.getElementById("MultiSelectDisp");
    });
        
    $(function() {$("#Negative_rightSelected").click(function() {
        insertarElementInSelect("MultiSelectDisp", "Negative_to");});
    });

    $(function() {$("#Positive_leftSelected").click(function(){
        insertarElementInSelect("Positive_to", "MultiSelectDisp");});
    });
        
    $(function() {$("#Negative_leftSelected").click(function(){
        insertarElementInSelect("Negative_to", "MultiSelectDisp");});
    });

    function createMultipleSelectorSkeleton(id, opciones, opciones_in, opciones_out, divElement){
        var divForm = createDivClass("form-row", divElement);
        var divRow = createDivClass("row", divForm);
        var div_class_sm_3 = createDivClass("col-sm-3", divRow);
        createMultipleSelector('MultiSelectDisp', id, opciones, div_class_sm_3, 10);

        var div_class_sm_1 = createDivClass("col-sm-1", divRow);
        createButton("button", "Positive_rightSelected", "Añadir seleccionados", div_class_sm_1, ">", false);
        createButton("button", "Positive_leftSelected", "Quitar seleccionados", div_class_sm_1, "<", true);
        createButton("button", "Negative_rightSelected", "Añadir seleccionados", div_class_sm_1, ">", false);
        createButton("button", "Negative_leftSelected", "Quitar seleccionados", div_class_sm_1, "<", true);

        var div_class_sm_3_2 = createDivClass("col-sm-3", divRow);
        createMultipleSelector('Positive_to', id, opciones_in, div_class_sm_3_2, 5);
        createMultipleSelector('Negative_to', id, opciones_out, div_class_sm_3_2, 5);
        var div_class_sm_5 = createDivClass("col-sm-5", divRow);
    }

    function createInput(infoType, name, divElement){
        ele = document.createElement('input');
        ele.type = infoType;
        ele.name = name;
        ele.id = name;
        // accept = getInputAccept(item);
        // ele.accept= accept;
        // ele.accept="image/png, image/jpeg"
        divElement.appendChild(ele);

        idList.push(name);
    } 

    function createOptions(item, divElement){
        if(item.tipoPregunta.descripcion == 'simple'){
            var opciones = item.opciones;
            createSimpleSelector(item.id, opciones, divElement);
        } else if(item.tipoPregunta.destinos == 1) {
            var opciones = item.opciones;
            createMultipleSelectorSkeleton(item.id, opciones, [],[], divElement);
        } else {
            //luego
        }
    }

    function createTextArea(item, divElement){
        ele = document.createElement('textarea');
        id = item.id;
        ele.name = id;
        ele.id = id;
        divElement.appendChild(ele);

        idList.push(id);
    }

    function createImage(item, divElement){
        ele = document.createElement('img');
        ele.src = "#";
        id = item.id;
        ele.name = id;
        ele.id = id;
        divElement.appendChild(ele);

        idList.push(id);
    }
    
    function createAnswer(item, divElement){
        if (item.cerrada == '1'){
            createOptions(item, divElement);
        } else {
            if(item.tipoPregunta.descripcion == 'image'){
                createImage(item, divElement);
            } else if(item.tipoPregunta.descripcion == 'textarea'){
                createTextArea(item, divElement);
            } else {
                createInput(item.tipoPregunta.descripcion, item.id, divElement);
            }
        }
    }

    function createTextElement(type, div, info){
        var element = document.createElement(type);
        var text = document.createTextNode(info);
        element.appendChild(text);
        div.appendChild(element);
    }

    function createQuestions(item, divElement){
        preguntas = item.preguntas;
        for (var i = 0; i < preguntas.length; i++){
            var div = document.createElement("Div");
            div.className='row';
            div.style.padding = "15px";
            divElement.appendChild(div);
            var item = preguntas[i];
            createTextElement("P", div, item.descripcion);
            createAnswer(item, div);
        }
    }

    function crearItemSeccion(item, contenedor){

        // Creating a div element
        var divElement = document.createElement("Div");
        divElement.id = "Seccion"+item.id;
        divElement.style.padding = "10px";
        divElement.className="form-row";
        divElement.style.textAlign = "lefth";

        var divSeleccion = createDivClass("row", divElement);
        var div_class_sm_1 = createDivClass("col-sm-1", divSeleccion);
        createTextElement("h4", div_class_sm_1, item.nombre);

        createQuestions(item, divElement);
        contenedor.appendChild(divElement);
        
        return divElement;
    }

    function construirSecciones(childs, contenedor){
        for (var i = 0; i < childs.length; i++){
            var item = childs[i];
            var itemSeccion = crearItemSeccion(item, contenedor);
            contenedor.appendChild(itemSeccion);
        }
    }

    function createHref(info, divElement){
        ele = document.createElement('a');
        ele.href = info;
        divElement.appendChild(ele);

        var div = document.createElement("Div");
        div.className = "btn";

        var text = document.createTextNode("Cancelar");
        div.appendChild(text);
        ele.appendChild(div);
    }

    function updateInput() {
        var datos  = [];
        var objeto = {};

        for(var i= 0; i < idList.length; i++) {
            var nombre = idList[i]
            datos.push({ 
                "id"    : idList[i],
                "respuesta"  : $("#"+idList[i]).val(),
            });
        }
        objeto.datos = datos;

        var json = JSON.stringify(objeto);
        console.log(json);

        $("#JsonData").val(json);
    }

    function createFormulario(){
        var contenedor = document.getElementsByTagName("div")[0];

        var divFormulario = document.createElement("Div");
        divFormulario.id = "Formulario"+formulario.id;
        divFormulario.style.paddingTop = "15px";
        createTextElement("h3", divFormulario, formulario.descripcion);
        contenedor.appendChild(divFormulario);

        construirSecciones(formulario.secciones, divFormulario);
        // createCancelOkButtons(contenedor);
    }

    createFormulario();
</script>
<form method="post"  name="formPerfil" >
    <div class="row">
        <input type="text" name="JsonData" id="JsonData">
        <a href="#">
            <div class="btn">Cancelar</div>
        </a>
        <button id="submit" type="submit" onclick="updateInput()">Confirmar</button>
    </div>
</form>
