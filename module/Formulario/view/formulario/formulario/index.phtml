<script type="text/javascript" src="<?= $this->basePath('/js/operation/permits/forms/jquery.multi-select.js') ?>"></script>
<script>
    var formulario = <?= $formulario ?>;

    function updateJson(idSeccion, idPregunta, respuesta) {
        childs = formulario.secciones;
        for (var i = 0; i < childs.length; i++){
            if(childs[i].id == idSeccion){
                preguntas = childs[i].preguntas;
                for (var j = 0; j < preguntas.length; j++){
                    if(preguntas[j].idPregunta == idPregunta){
                        preguntas[j].respuesta = respuesta ;
                    }
                }
            }
        }
    }

    function obtenerValoresSelector(id) {
        var values = [];
        var options =$('#'+id+' option');
        console.log(options);
        // console.log($('#destino_0_id_3_seccion_1 option')[0].value);
        for(var i=0; i < options.length; i++){
            values.push(options[i].value);
            console.log(options[i].value);
        }
        return values;
    }

    function obtenerListaOpciones(lista){
        var output = [];
        for (var i=0; i < lista.length; i++) {
            var item = lista[i];
            var arreglo = []
            arreglo.push(item.id);
            arreglo.push(item.descripcion);
            output.push(arreglo);
        }
        return output;
    }

    function obtenerOpcionesSelectorMultiple(idSelector){
        var childs = formulario.secciones;
        for (var i = 0; i < childs.length; i++){
            if(childs[i].id == idSeccion){
                var preguntas = childs[i].preguntas;
                for (var j = 0; j < preguntas.length; j++){
                    if(preguntas[j].idPregunta == idPregunta){
                        var resp = preguntas[j].respuesta;
                        for (var k = 0; k < resp.length; k++){
                            // var idSelectorJSON = resp[k].destino+"_seccion_"+idSeccion;
                            // console.log(idSelectorJSON);
                            if(resp[k].destino == idSelector) {
                                opciones = resp[k].opcion;
                            }
                        }
                    }
                }
            }
        }
        return opciones;
    }

    function updateJsonRespuestaSelector(idSelector, opciones) {
        var childs = formulario.secciones;
        for (var i = 0; i < childs.length; i++){
            if(childs[i].id == idSeccion){
                var preguntas = childs[i].preguntas;
                for (var j = 0; j < preguntas.length; j++){
                    if(preguntas[j].idPregunta == idPregunta){
                        var resp = preguntas[j].respuesta;
                        for (var k = 0; k < resp.length; k++){
                            // var idSelectorJSON = resp[k].destino+"_seccion_"+idSeccion;
                            // console.log(idSelectorJSON);
                            if(resp[k].destino == idSelector) {
                                resp[k].opcion = opciones;
                            }
                        }
                    }
                }
            }
        }
    }

    function updateIdDestinoJsonSelectores(idSeccion, idPregunta) {
        var childs = formulario.secciones;
        for (var i = 0; i < childs.length; i++){
            if(childs[i].id == idSeccion){
                var preguntas = childs[i].preguntas;
                for (var j = 0; j < preguntas.length; j++){
                    if(preguntas[j].idPregunta == idPregunta){
                        var resp = preguntas[j].respuesta;
                        for (var k = 0; k < resp.length; k++){
                            var idSelectorJSON = resp[k].destino+"_seccion_"+idSeccion;
                            resp[k].destino = idSelectorJSON;
                        }
                    }
                }
            }
        }
    }

    function updateJsonMultipleSelector(idSeccion, idPregunta, idSelector) {
        var value = obtenerValoresSelector(idSelector);
        // updateJsonRespuestaSelector(idSeccion, idPregunta, value, idSelector);
    }

    function createListFromJSONLista(selector, lista, seleccione) {
        if (seleccione){
            var option = document.createElement("option");
            option.value =  -1;
            option.text = 'Seleccione';
            selector.appendChild(option);
        }
        for (var i=0; i < lista.length; i++) {
            var option = document.createElement("option");
            option.value = lista[i][0];
            option.text = lista[i][1];
            selector.appendChild(option);
            
        }
        return selector;
    }

    function updateJsonSimple(idSeccion, idPregunta, idRespuesta) {
        var respuesta = $("#"+idRespuesta).val();
        updateJson(idSeccion, idPregunta, respuesta);
    }

    function createSimpleSelector(id, opciones, divElement, idSeccion) {
        
        var selector = document.createElement("select");
        idSelector = "pregunta_"+id+"_seccion_"+idSeccion;
        selector.id = idSelector;
        var opciones = obtenerListaOpciones(opciones);
        var selector = createListFromJSONLista(selector, opciones, true);
        selector.onchange = function() {updateJsonSimple(idSeccion, id, idSelector)};
        divElement.appendChild(selector);
    }

    function createMultipleSelector(id, divElement, size, idPregunta, idSeccion) {
        var selector = document.createElement("select");
        selector.name = name;
        idSelector = id+idPregunta+"_seccion_"+idSeccion;
        selector.id = idSelector;
        selector.multiple = true;
        selector.className = "form-control";
        selector.size = size;
        selector.style.marginBottom = "5px";
        // var opciones = obtenerListaOpciones(opciones);
        var opciones = obtenerOpcionesSelectorMultiple(idSelector);
        var selector = createListFromJSONLista(selector, opciones, false);
        divElement.appendChild(selector);
        // console.log($('#destino_0_id_3_seccion_1 option')[0].value);
    }

    function createDivClass(info, div) {
        var divClass = document.createElement("Div");
        divClass.className = info;
        div.appendChild(divClass);
        return divClass;
    }
    
    function insertarElementInSelect(origin, destination, id, idSeccion){
        idSelector = origin+id+"_seccion_"+idSeccion;
        var select1 = document.getElementById(idSelector);
        var options = [];
        for (var i = 0; i < select1.length; i++) {
            if (select1.options[i].selected) {
                var array = [];
                array.push(select1.options[i].value);
                array.push(select1.options[i].text);
                options.push(array);
            }
        }

        var optionOrigin = deleteOptions(idSelector, id, idSeccion);
        var selectIn = document.getElementById(destination+id+"_seccion_"+idSeccion);
        updateJsonRespuestaSelector(selectIn, options);
        var opciones = obtenerOpcionesSelectorMultiple(selectIn);
        createListFromJSONLista(selectIn, opciones, false);
        manageButtons(id, idSeccion);
    }

    function createButton(infoType, id, title, divElement, icon, disabled, origin, destination, idPregunta, idSeccion){
        var button = document.createElement("button");
        button.type = infoType;
        button.id = id;
        button.title = title;
        button.className = "btn btn-primary";
        button.textContent = icon;
        button.disabled = disabled;
        button.style.marginTop = "15px";
        button.onclick = function() {insertarElementInSelect(origin, destination, idPregunta, idSeccion)};
        // var icono = document.createElement("i");
        // icono.className = "fas fa-angle-left";
        // button.appendChild(icono);
        divElement.appendChild(button);
    }

    function removeAllOptionSelector(origin){
        $('#'+origin).find('option')
            .remove()
            .end();
    }

    function deleteOptions(origin, idPregunta, idSeccion) {
        var select1 = document.getElementById(origin);
        var notSelected = [];
        for (var i = 0; i < select1.length; i++) {
            if (!select1.options[i].selected) {
                var array = [];
                array.push(select1.options[i].value);
                array.push(select1.options[i].text);
                notSelected.push(array);
            }
        }
        updateJsonRespuestaSelector(origin, notSelected);
        removeAllOptionSelector(origin);
        var opciones = obtenerOpcionesSelectorMultiple(origin);        
        createListFromJSONLista(select1, opciones, false);
        // updateJsonMultipleSelector(idSeccion, idPregunta, origin);
        return select1;
    }
    
    function manageButtons(id, idSeccion){
        if($('#destino_0_id_'+id+"_seccion_"+idSeccion+' option').length == 0){
            $("#button_1_R_id_"+id+"_seccion_"+idSeccion).prop('disabled', true);
            $("#button_2_R_id_"+id+"_seccion_"+idSeccion).prop('disabled', true);
        } else {
            $("#button_1_R_id_"+id+"_seccion_"+idSeccion).prop('disabled', false);
            $("#button_2_R_id_"+id+"_seccion_"+idSeccion).prop('disabled', false);
        }
        if($('#destino_1_id_'+id+"_seccion_"+idSeccion+' option').length == 0){
            $("#button_1_L_id_"+id+"_seccion_"+idSeccion).prop('disabled', true);
        } else {
            $("#button_1_L_id_"+id+"_seccion_"+idSeccion).prop('disabled', false);
        }
        if($('#destino_2_id_'+id+"_seccion_"+idSeccion+' option').length == 0){
            $("#button_2_L_id_"+id+"_seccion_"+idSeccion).prop('disabled', true);
        } else {
            $("#button_2_L_id_"+id+"_seccion_"+idSeccion).prop('disabled', false);
        }
    }

    function createMultipleSelectorSkeleton(idPregunta, divElement, idSeccion){
        var divForm = createDivClass("form-row", divElement);
        var divRow = createDivClass("row", divForm);
        var div_class_sm_3 = createDivClass("col-sm-5", divRow);
        updateIdDestinoJsonSelectores(idSeccion, idPregunta);

        createMultipleSelector('destino_0_id_', div_class_sm_3, 10, idPregunta, idSeccion);

        var div_class_sm_1 = createDivClass("col-sm-2", divRow);
        createButton("button", "button_1_R_id_"+idPregunta+"_seccion_"+idSeccion, "Añadir seleccionados", div_class_sm_1, ">", false, "destino_0_id_", "destino_1_id_", idPregunta,idSeccion);
        createButton("button", "button_1_L_id_"+idPregunta+"_seccion_"+idSeccion, "Quitar seleccionados", div_class_sm_1, "<", true, "destino_1_id_", "destino_0_id_", idPregunta,idSeccion);
        createButton("button", "button_2_R_id_"+idPregunta+"_seccion_"+idSeccion, "Añadir seleccionados", div_class_sm_1, ">", false, "destino_0_id_", "destino_2_id_", idPregunta,idSeccion);
        createButton("button", "button_2_L_id_"+idPregunta+"_seccion_"+idSeccion, "Quitar seleccionados", div_class_sm_1, "<", true, "destino_2_id_", "destino_0_id_", idPregunta,idSeccion);

        var div_class_sm_3_2 = createDivClass("col-sm-5", divRow);
        createMultipleSelector('destino_1_id_', div_class_sm_3_2, 5, idPregunta, idSeccion);
        createMultipleSelector('destino_2_id_', div_class_sm_3_2, 5, idPregunta, idSeccion);
        var div_class_sm_5 = createDivClass("col-sm-1", divRow);
    }

    function createInput(infoType, idPregunta, divElement, idSeccion){
        ele = document.createElement('input');
        ele.type = infoType;
        var idEle = "pregunta_"+idPregunta+"_seccion_"+idSeccion;
        ele.name = idEle;
        ele.id = idEle;
        ele.onchange = function() {updateJsonSimple(idSeccion, idPregunta, idEle)};
        // accept = getInputAccept(item);
        // ele.accept= accept;
        // ele.accept="image/png, image/jpeg"
        divElement.appendChild(ele);
    } 

    function createOptions(item, divElement, idSeccion){
        if(item.tipoPregunta.descripcion == 'simple'){
            var opciones = item.opciones;
            createSimpleSelector(item.idPregunta, opciones, divElement, idSeccion);
        } else {
            createMultipleSelectorSkeleton(item.idPregunta, divElement, idSeccion);
        } 
    }

    function createTextArea(item, divElement, idSeccion){
        ele = document.createElement('textarea');
        var id = "pregunta_"+item.idPregunta+"_seccion_"+idSeccion;
        ele.name = id;
        ele.id = id;
        divElement.appendChild(ele);
        ele.onchange = function() {updateJsonSimple(idSeccion, item.idPregunta, id)};
    }

    function createImage(item, divElement, idSeccion){
        ele = document.createElement('img');
        ele.src = "#";
        var id = "pregunta_"+item.idPregunta+"_seccion_"+idSeccion;
        ele.name = id;
        ele.id = id;
        divElement.appendChild(ele);
    }
    
    function createAnswer(item, divElement, idSeccion){
        if (item.cerrada == '1'){
            createOptions(item, divElement, idSeccion);
        } else {
            if(item.tipoPregunta.descripcion == 'image'){
                createImage(item, divElement, idSeccion);
            } else if(item.tipoPregunta.descripcion == 'textarea'){
                createTextArea(item, divElement, idSeccion);
            } else {
                createInput(item.tipoPregunta.descripcion, item.idPregunta, divElement, idSeccion);
            }
        }
    }

    function createTextElement(type, div, info){
        var element = document.createElement(type);
        var text = document.createTextNode(info);
        element.appendChild(text);
        div.appendChild(element);
    }

    function createQuestions(item, divElement){
        preguntas = item.preguntas;
        for (var i = 0; i < preguntas.length; i++){
            var div = document.createElement("Div");
            div.className='row';
            div.style.padding = "15px";
            divElement.appendChild(div);
            var item2 = preguntas[i];
            createTextElement("P", div, item2.descripcion);
            createAnswer(item2, div, item.id);
        }
    }

    function crearItemSeccion(item, contenedor){

        // Creating a div element
        var divElement = document.createElement("Div");
        divElement.id = "Seccion_id_"+item.id;
        divElement.style.padding = "10px";
        divElement.className="form-group";
        divElement.style.textAlign = "lefth";

        var divSeccion = createDivClass("row", divElement);
        var div_class_sm_2 = createDivClass("col-sm-1", divSeccion);
        createTextElement("h4", div_class_sm_2, item.nombre);

        createQuestions(item, divElement);
        contenedor.appendChild(divElement);
        
        return divElement;
    }

    function construirSecciones(childs, contenedor){
        for (var i = 0; i < childs.length; i++){
            var item = childs[i];
            var itemSeccion = crearItemSeccion(item, contenedor);
            contenedor.appendChild(itemSeccion);
        }
    }

    function updateInput() {
        data = JSON.stringify(formulario);
        $("#JsonData").val(data);
        console.log($("#JsonData").val());
    }

    function createFormulario(){
        var contenedor = document.getElementsByTagName("div")[0];

        var divFormulario = document.createElement("Div");
        divFormulario.id = "Formulario_id_"+formulario.idFormulario;
        divFormulario.style.paddingTop = "15px";
        createTextElement("h3", divFormulario, formulario.descripcion);
        contenedor.appendChild(divFormulario);

        construirSecciones(formulario.secciones, divFormulario);
    }

    createFormulario();
</script>
<form method="post"  action="<?=$this->url("formulario/show-form",["action" => "showForm"])?>" name="formPerfil" >
    <div class="row">
        <input type="hidden" name="JsonData" id="JsonData">
        <a href="#">
            <div class="btn btn-primary">Cancelar</div>
        </a>
        <button id="submit" class="btn btn-primary" type="button" onclick="updateInput()">Confirmar</button>
    </div>
</form>


